<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DoodleDuel Lite</title>
    <style>
        /* CRASH PREVENTION: Simplifies the layout for low RAM */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            position: fixed; overflow: hidden; background: #5a8fd4; font-family: sans-serif;
        }
        #game { display: flex; flex-direction: column; height: 100%; padding: 10px; }
        #header { color: white; text-align: center; font-weight: bold; margin-bottom: 5px; }
        
        /* Fixed Size Canvas to stop GPU crashes */
        canvas { 
            background: white; border-radius: 10px; 
            width: 100%; height: auto; aspect-ratio: 4/3;
            touch-action: none; display: block;
        }

        .tools { display: flex; gap: 5px; margin: 10px 0; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; background: white; }
        .active { background: #43b02a; color: white; }

        .chat { 
            background: white; border-radius: 10px; flex: 1; 
            display: flex; flex-direction: column; min-height: 0; 
        }
        #msgs { flex: 1; overflow-y: auto; padding: 8px; font-size: 14px; }
        input { 
            width: 100%; padding: 15px; border: none; border-top: 1px solid #eee; 
            font-size: 16px; outline: none; border-radius: 0 0 10px 10px;
        }
    </style>
</head>
<body>

<div id="game">
    <div id="header">WORD: BANANA</div>
    <canvas id="c"></canvas>
    
    <div class="tools">
        <input type="color" id="col" value="#000000" style="width: 40px; height: 40px; border: none; background: none;">
        <button id="bB" class="active" onclick="setT('b')">üñåÔ∏è</button>
        <button id="kB" onclick="setT('k')">ü™£</button>
        <button onclick="clr()" style="background:#ff4757; color:white;">CLR</button>
    </div>

    <div class="chat">
        <div id="msgs"></div>
        <input type="text" id="in" placeholder="Type here..." autocomplete="off">
    </div>
</div>

<script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha: false }); // High-performance mode
    const msgBox = document.getElementById('msgs');
    const input = document.getElementById('in');
    
    // Set a fixed internal resolution to prevent lag/crashing
    canvas.width = 400;
    canvas.height = 300;
    ctx.fillStyle = "white";
    ctx.fillRect(0,0,400,300);

    let drawing = false, tool = 'b';

    function getP(e) {
        const rect = canvas.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return {
            x: (t.clientX - rect.left) * (400 / rect.width),
            y: (t.clientY - rect.top) * (300 / rect.height)
        };
    }

    const start = (e) => {
        const p = getP(e);
        if(tool === 'k') {
            fill(Math.floor(p.x), Math.floor(p.y));
        } else {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
        }
    };

    const move = (e) => {
        if(!drawing || tool !== 'b') return;
        const p = getP(e);
        ctx.lineTo(p.x, p.y);
        ctx.strokeStyle = document.getElementById('col').value;
        ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke();
    };

    canvas.addEventListener('touchstart', start);
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); });
    canvas.addEventListener('touchend', () => drawing = false);

    // FIXED TYPING: Uses "input" event for instant response
    input.onkeydown = (e) => {
        if(e.key === 'Enter') {
            const v = input.value.toUpperCase().trim();
            if(v === "BANANA") msgBox.innerHTML += "<div>üèÜ <b>CORRECT!</b></div>";
            else if(v) msgBox.innerHTML += "<div>" + v + "</div>";
            input.value = "";
            msgBox.scrollTop = msgBox.scrollHeight;
        }
    };

    function setT(t) {
        tool = t;
        document.getElementById('bB').className = t === 'b' ? 'active' : '';
        document.getElementById('kB').className = t === 'k' ? 'active' : '';
    }

    function clr() { ctx.fillStyle="white"; ctx.fillRect(0,0,400,300); }

    // FAST FILL: Simplified to prevent browser freezing
    function fill(x, y) {
        const color = document.getElementById('col').value;
        const img = ctx.getImageData(0, 0, 400, 300);
        const data = img.data;
        const startIdx = (y * 400 + x) * 4;
        const sR = data[startIdx], sG = data[startIdx+1], sB = data[startIdx+2];
        
        const fR = parseInt(color.slice(1,3),16), fG = parseInt(color.slice(3,5),16), fB = parseInt(color.slice(5,7),16);
        if(sR === fR && sG === fG && sB === fB) return;

        const queue = [[x, y]];
        while(queue.length > 0) {
            const [cx, cy] = queue.shift(); // Use shift for cleaner memory
            const i = (cy * 400 + cx) * 4;
            if(data[i] === sR && data[i+1] === sG && data[i+2] === sB) {
                data[i] = fR; data[i+1] = fG; data[i+2] = fB; data[i+3] = 255;
                if(cx > 0) queue.push([cx-1, cy]);
                if(cx < 399) queue.push([cx+1, cy]);
                if(cy > 0) queue.push([cx, cy-1]);
                if(cy < 299) queue.push([cx, cy+1]);
            }
        }
        ctx.putImageData(img, 0, 0);
    }
</script>
</body>
</html>
